name: PR Comment

on:
  workflow_run:
    workflows: ["PR Build"]
    types:
      - completed

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  comment:
    runs-on: ubuntu-slim
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Download artifact
        uses: actions/github-script@v8
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }},
            });
            const matchArtifact = artifacts.data.artifacts.filter((artifact) => {
              return artifact.name.startsWith("pr-build-");
            })[0];
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
            });
            const fs = require('fs');
            fs.writeFileSync('${{ github.workspace }}/pr-build.zip', Buffer.from(download.data));

      - name: Extract artifact
        run: |
          mkdir -p pr-build
          unzip -d pr-build/ pr-build.zip

      - name: Read PR info
        id: pr_info
        run: |
          PR_NUMBER=$(cat pr-build/pr/NR)
          PR_SHA=$(cat pr-build/pr/SHA)
          ZIP_FILE=$(ls pr-build/*.zip | head -n 1)
          ZIP_NAME=$(basename "$ZIP_FILE")
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "pr_sha=$PR_SHA" >> "$GITHUB_OUTPUT"
          echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"

      - name: Comment on PR
        uses: actions/github-script@v8
        env:
          PR_NUMBER: ${{ steps.pr_info.outputs.pr_number }}
          PR_SHA: ${{ steps.pr_info.outputs.pr_sha }}
          ZIP_NAME: ${{ steps.pr_info.outputs.zip_name }}
        with:
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            const prSha = process.env.PR_SHA;
            const zipName = process.env.ZIP_NAME;
            const runId = ${{ github.event.workflow_run.id }};
            const { repo, owner } = context.repo;

            // Verify PR number is numeric
            if (!Number.isInteger(prNumber) || prNumber <= 0) {
              core.setFailed('Invalid PR number');
              return;
            }

            const artifactName = `pr-build-${prNumber}`;

            const commentBody = [
              '## [BUILD] Testing/Debug Build Ready',
              '',
              'A debug build has been built for this PR and is available for 14 days.',
              '',
              `**Download**: [${artifactName}](https://nightly.link/${owner}/${repo}/actions/runs/${runId}/${artifactName})`,
              '',
              '**Build Info**:',
              `- Commit: \`${prSha.substring(0, 7)}\``,
              `- Artifact: \`${zipName}\``,
              '',
              '---',
              '',
              '## ⚠ CRITICAL WARNING - READ BEFORE DOWNLOADING ⚠',
              '',
              '**THIS IS AN UNTESTED PR BUILD FOR TESTING PURPOSES ONLY**',
              '',
              '⚠ DANGER - USE AT YOUR OWN RISK ⚠',
              '',
              '- ✖ NOT SAFE: This build has NOT been reviewed or tested for security vulnerabilities',
              '- ✖ UNVERIFIED CODE: Contains unreviewed code changes that may be malicious or buggy',
              '- ✖ NO WARRANTY: This build comes with ABSOLUTELY NO WARRANTY of any kind',
              '- ✖ POTENTIAL RISKS: May contain malware, backdoors, data theft code, or cause device instability',
              '- ✖ SAVE RISK: May crash your game or corrupt worlds; BACK UP YOUR SAVES',
              '- ✖ SHOCK RISK: Shocks may trigger unexpectedly',
              '- ⏲ TEMPORARY: Available for 14 days only',
              '',
              '⚠ WARNING: DO NOT INSTALL UNLESS:',
              '- ✔ You are an experienced player/dev who understands the risks',
              '- ✔ You have reviewed the PR code changes thoroughly',
              '- ✔ You accept full responsibility for any damage or data loss',
              '- ✔ You understand this may compromise your device/server/world',
              '',
              '**BY DOWNLOADING THIS BUILD, YOU ACKNOWLEDGE AND ACCEPT ALL RISKS.**',
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: commentBody
            });
