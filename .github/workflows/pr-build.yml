name: PR Build

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - ".github/workflows/**"

permissions:
  contents: read

concurrency:
  group: pr-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Save PR number
        run: |
          mkdir -p ./pr
          echo ${{ github.event.number }} > ./pr/NR
          echo ${{ github.event.pull_request.head.sha }} > ./pr/SHA

      - name: Gather variables
        id: vars
        run: |
          GIT_SHA7=$(git rev-parse --short HEAD)
          echo "GIT_SHA7=$GIT_SHA7"
          echo "GIT_SHA7=$GIT_SHA7" >> "$GITHUB_OUTPUT"
          DATE=$(date -u +'%Y.%m.%d')
          echo "DATE=$DATE"
          echo "DATE=$DATE" >> "$GITHUB_OUTPUT"
          PR_NUMBER=${{ github.event.pull_request.number || 'manual' }}
          echo "PR_NUMBER=$PR_NUMBER"
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "8.0.x"

      - name: Clean potential old build assets (non-blocking, just in case)
        run: |
          rm -rf src/bin || true
          rm -rf src/obj || true
          rm -rf mods || true
          rm -f VintageShock-*.zip || true

      - name: Download Vintage Story dependencies
        run: |
          mkdir -p /opt/vintagestory
          wget -q https://cdn.vintagestory.at/gamefiles/stable/vs_server_linux-x64_1.19.8.tar.gz
          tar -xzf vs_server_linux-x64_1.19.8.tar.gz -C /opt/vintagestory

      - name: Build mod
        run: dotnet build VintageShock.sln -c Release /p:GameDir="/opt/vintagestory"

      - name: Locate zip
        id: locate_zip
        run: |
          zip_path=$(ls VintageShock-*.zip | head -n 1)
          if [ -z "$zip_path" ]; then
            echo "No VintageShock zip found" >&2
            exit 1
          fi
          echo "zip_path=$zip_path" >> "$GITHUB_OUTPUT"
          echo "zip_name=$(basename "$zip_path")" >> "$GITHUB_OUTPUT"

      - name: Upload PR info and build
        uses: actions/upload-artifact@v6
        with:
          name: pr-build-${{ github.event.pull_request.number }}
          path: |
            pr/
            ${{ steps.locate_zip.outputs.zip_path }}
          retention-days: 14
